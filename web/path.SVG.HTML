<html>
<head>
<title>Various Test Beds for simple data manipulation for
	Dummies</title>



<style type="text/css">
table#append_here tbody tr td {
	background-color: #CC0;
}

table#append_here tbody tr td.0 {
	background-color: #999;
}

table#append_here tbody tr td.N {
	background-color: #F00;
}

table#append_here tbody tr td.J {
	background-color: #0F0;
}

table#append_here tbody tr td.X {
	background-color: #999;
}
</style>
</head>

<body>


	<h2>read CSV</h2>

	<input type="file" id="filesCSV" name="files[]" /> // inserted into
	DOM
	<table id="append_here">
		<tbody>
		</tbody>
	</table>

	<script>
		//https://developer.mozilla.org/de/docs/Web/JavaScript/Reference/Global_Objects/Array/forEach

		// Production steps of ECMA-262, Edition 5, 15.4.4.18
		// Reference: http://es5.github.io/#x15.4.4.18
		if (!Array.prototype.forEach) {

			Array.prototype.forEach = function(callback, thisArg) {

				var T, k;

				if (this == null) {
					throw new TypeError(' this is null or not defined');
				}

				// 1. Let O be the result of calling ToObject passing the |this| value as the argument.
				var O = Object(this);

				// 2. Let lenValue be the result of calling the Get internal method of O with the argument "length".
				// 3. Let len be ToUint32(lenValue).
				var len = O.length >>> 0;

				// 4. If IsCallable(callback) is false, throw a TypeError exception.
				// See: http://es5.github.com/#x9.11
				if (typeof callback !== "function") {
					throw new TypeError(callback + ' is not a function');
				}

				// 5. If thisArg was supplied, let T be thisArg; else let T be undefined.
				if (arguments.length > 1) {
					T = thisArg;
				}

				// 6. Let k be 0
				k = 0;

				// 7. Repeat, while k < len
				while (k < len) {

					var kValue;

					// a. Let Pk be ToString(k).
					//   This is implicit for LHS operands of the in operator
					// b. Let kPresent be the result of calling the HasProperty internal method of O with argument Pk.
					//   This step can be combined with c
					// c. If kPresent is true, then
					if (k in O) {

						// i. Let kValue be the result of calling the Get internal method of O with argument Pk.
						kValue = O[k];

						// ii. Call the Call internal method of callback with T as the this value and
						// argument list containing kValue, k, and O.
						callback.call(T, kValue, k, O);
					}
					// d. Increase k by 1.
					k++;
				}
				// 8. return undefined
			};
		}

		///////////////

		// http://stackoverflow.com/questions/6654351/check-file-uploaded-is-in-csv-format
		// http://stackoverflow.com/questions/1181575/javascript-determine-whether-an-array-contains-a-value
		function Only_process_CSV_files(type) {
			var allowed_type = [ 'application/vnd.ms-excel', 'text/plain',
					'text/csv', 'text/tsv' ];

			for ( var i = 0; i < allowed_type.length; i++) {
				if (type == allowed_type[i])
					return true;
			}
			return false;
		}

		// http://www.html5rocks.com/de/tutorials/file/dndfiles/
		function handleFileSelectCSV(evt) {
			var file = evt.target.files[0]; // Multiple files would need a closure some lines down

			if (Only_process_CSV_files(file.type)) {
				var reader = new FileReader();
				// http://www.htmlgoodies.com/beyond/javascript/read-text-files-using-the-javascript-filereader.html#fbid=Ex_PuXpdl4s
				reader.onload = convert_csv_to_HTML;
				reader.readAsText(file);
			}
		}

		document.getElementById('filesCSV').addEventListener('change',
				handleFileSelectCSV, false);

		const
		state = [ 'N', 'J', 'X' ];


		function doRow(balance, we, t0) {
			for ( var we_i = 0; we_i < we.length; we_i++) {
				var we_e = we[we_i];
				switch (we_e.className) {
				case state[0]:
					balance++;
					break;
				case state[1]:
					balance--;
					break;
				default:
					continue;
				}
				we_e.innerHTML = we_e.className = t0;
			}

			return balance;
		}

		// Since we do not allow " to have a special meaning, we do not need http://papaparse.com/
		function convert_csv_to_HTML(e) {

			var inp_0 = e.target.result;
			var out_t = document.getElementById('append_here');
			var out_0 = out_t.getElementsByTagName('TBODY')[0]; // Table Body

			var inp_lines = inp_0.split('\n');

			inp_lines.forEach(function(line, i0)
			//for ( var i0 = 0; i0 < inp_lines.length; i0++) 
			{
				//var line = inp_lines[i0];

				var out_1 = document.createElement("tr"); // Table Row
				out_0.appendChild(out_1);

				var fields = line.split(',');
				fields.forEach(function(field, i1)
				//		for ( var i1 = 0; i1 < fields.length; i1++) 
				{
					//var field = fields[i1];

					var out_2 = document.createElement("td"); // Table Cell
					var t = field.substring(0, 1)
					if (i0 == 0) {
						out_2.className = 'C';
						out_2.onclick = function() {
							var we = this.parentNode.parentNode.rows;
							var balance = 0;
							var t0 = state[0];
							for ( var t1 = 0; balance >= t1; t1++) {
								//we.forEach(function(row)
								for ( var we_i = 0; we_i < we.length; we_i++) {
									var cs = we[we_i].cells;
									//var cs = row.cells;
									if (cs.length <= this.cellIndex) {
										continue;
									}
									var we_e = cs[this.cellIndex];

									switch (we_e.className) {
									case state[0]:
										balance++;
										break;
									case state[1]:
										balance--;
										break;
									default:
										continue;
									}

									we_e.innerHTML = we_e.className = t0;
								}

								t0 = state[1];
							}
						};
					} else {
						if (i1 <= 1) {
							out_2.className = 'R';

							out_2.onclick = function() {
								var we = this.parentNode.cells;
								var balance = 0;
								var t0 = state[0];
								for ( var t1 = 0; balance >= t1; t1++) {
									//we.foreach(function(we_e)

									balance = doRow(balance, we, t0);

									t0 = state[1];
								}
							};
						} else {

							if (t.match(/[A-Z]/i)) {
								out_2.className = t;
								out_2.onclick = function() {
									var t0;
									switch (this.className) {
									case state[0]:
										t0 = state[1];
										break;
									case state[1]:
										t0 = state[2];
										break;
									case state[2]:
										t0 = state[0];
										break;
									default:
										return;
									}
									this.innerHTML = this.className = t0;
								};
							}
						}
					}
					var textnode = document.createTextNode(field);
					out_2.appendChild(textnode);

					out_1.appendChild(out_2);

				}); // for each 
			}); // for each

			out_0.rows[0].cells[1].onclick = function() {
				var we = this.parentNode.parentNode.rows;
				var balance = 0;
				var t0 = state[0];
				for ( var t1 = 0; balance >= t1; t1++) {
					//we.forEach(function(row)//
					for ( var we_i = 0; we_i < we.length; we_i++) {
						var cs = we[we_i].cells; // 
						//cs.forEach(function(we_e)//

						balance = doRow(balance, cs, t0);

					}

					t0 = state[1];
				}
			};
		}
	</script>


	<h2>write CSV</h2>

	<script>
		function Table_To_CSV() {
			document.getElementById("fat");

			var out_0 = "";
			var inp_t = document.getElementById('append_here');
			var inp_0 = inp_t.getElementsByTagName('TBODY')[0]; // Table Body

			inp_1 = inp_0.childNodes;
			//inp_1.foreach(function(line) 
			for ( var i0 = 0; i0 < inp_1.length; i0++) 
			{
				var line = inp_1[i0];

				if (line.nodeType != 1) {
					continue;
				}

				var out_1 = "";

				var fields = line.childNodes;
				//fields.foreach(function(field)
				for ( var i1 = 0; i1 < fields.length; i1++) 
				{
					var field = fields[i1];

					if (field.nodeType != 1) {
						continue;
					}

					out_1 += "," + field.innerHTML;
				}

				out_0 += '\n' + out_1.substring(1); //not system.newline, but to my spec. Heinricht wants \r \n
			}

			// http://www.w3schools.com/jsref/jsref_encodeuri.asp
			res = encodeURI(out_0.substring(1));

			// http://stackoverflow.com/questions/7034754/how-to-set-a-file-name-using-window-open			
			var downloadLink = document.getElementById("csv_a");//createElement("a");
			downloadLink.href = 'data:text/csv;charset=utf-8,' + res;
			downloadLink.click();

		}
	</script>

	<button onclick="Table_To_CSV()">TableToCSV</button>

	<a id="csv_a" download="somedata_dynamic.csv" href="placeholer"
		style="display: none"> click me to save last generated csv </a>


</body>
</html>