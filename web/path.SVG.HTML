<html>
<head>
<title>Various Test Beds for simple data manipulation for
	Dummies</title>

</head>
<body>


	<h2>read CSV</h2>

	<input type="file" id="filesCSV" name="files[]" />


	// inserted into DOM
	<table id="append_here">
		<tbody>
		</tbody>
	</table>

	<script>
		function Only_process_CSV_files(type) {
			var allowed_type = [ 'application/vnd.ms-excel', 'text/plain',
					'text/csv', 'text/tsv' ];

			for ( var i = 0; i < allowed_type.length; i++) {
				if (type == allowed_type[i])
					return true;
			}
			return false;
		}

		function handleFileSelectCSV(evt) {
			var files = evt.target.files;

			for ( var i = 0, f; f = files[i]; i++) {

				if (!Only_process_CSV_files(f.type)) {
					continue;
				}

				var reader = new FileReader();
				// http://www.htmlgoodies.com/beyond/javascript/read-text-files-using-the-javascript-filereader.html#fbid=Ex_PuXpdl4s
				// read a singel CSV. Code for multiple files needs a Closure
				reader.onload = convert_csv_to_HTML;
				reader.readAsText(f);
			}
		}

		document.getElementById('filesCSV').addEventListener('change',
				handleFileSelectCSV, false);
		
		function convert_csv_to_HTML(e) { 
			
			var span = document.createElement('span');
			span.innerHTML = [ '<pre>', e.target.result, '<pre/>' ]
					.join('');

			var inp_0 = e.target.result;
			var out_t = document.getElementById('append_here');
			var out_0 = out_t.getElementsByTagName('TBODY')[0];					

			var inp_lines = inp_0.split('\n');

			for ( var i0 = 0; i0 < inp_lines.length; i0++) {
				var line = inp_lines[i0];

				var out_1 = document.createElement("tr");
				out_0.appendChild(out_1);

				var fields = line.split(',');
				for ( var i1 = 0; i1 < fields.length; i1++) {
					var field = fields[i1];

					var out_2 = document.createElement("td");
					var t = field.substring(0, 1)
					if (i0 == 0) {
						out_2.className = 'C';
						out_2.onclick = function() {
							var we = this.parentNode.parentNode.rows;
							var balance = 0;
							var t0 = 'N';
							for ( var t1 = 0; balance >= t1; t1++) {
								for ( var we_i = 0; we_i < we.length; we_i++) {
									var cs = we[we_i].cells;
									if (cs.length <= this.cellIndex) {
										continue;
									}
									var we_e = cs[this.cellIndex];

									switch (we_e.className) {
									case 'N':
										balance++;
										break;
									case 'J':
										balance--;
										break;
									default:
										continue;
									}
									we_e.className = t0;
									we_e.innerHTML = t0;

								}

								t0 = 'J';
							}
						};
					} else {
						if (i1 <= 1) {
							out_2.className = 'R';
							
							out_2.onclick = function() {
								var we = this.parentNode.cells;
								var balance = 0;
								var t0 = 'N';
								for ( var t1 = 0; balance >= t1; t1++) {
									for ( var we_i = 0; we_i < we.length; we_i++) {
										var we_e = we[we_i];
										switch (we_e.className) {
										case 'N':
											balance++;
											break;
										case 'J':
											balance--;
											break;
										default:
											continue;
										}
										we_e.className = t0;
										we_e.innerHTML = t0;
									}

									t0 = 'J';
								}
							};
						} else {

							if (t.match(/[A-Z]/i)) {
								out_2.className = t;
								out_2.onclick = function() {
									var t0;
									switch (this.className) {
									case 'N':
										t0 = 'J';
										break;
									case 'J':
										t0 = 'X';
										break;
									case 'X':
										t0 = 'N';
										break;
									default:
										return;
									}
									this.className = t0;
									this.innerHTML = t0;
								};
							}
						}
					}
					var textnode = document.createTextNode(field);
					out_2.appendChild(textnode);

					out_1.appendChild(out_2);

				}
			} // for

			
			out_0.rows[0].cells[1].onclick = function() {
				var we = this.parentNode.parentNode.rows;
				var balance = 0;
				var t0 = 'N';
				for ( var t1 = 0; balance >= t1; t1++) {
					for ( var we_i = 0; we_i < we.length; we_i++) {
						var cs = we[we_i].cells;
						for ( var we_0 = 2; we_0 < cs.length; we_0++) {
							var we_e = cs[we_0];

							switch (we_e.className) {
							case 'N':
								balance++;
								break;
							case 'J':
								balance--;
								break;
							default:
								continue;
							}
							we_e.className = t0;
							we_e.innerHTML = t0;
						}
					}

					t0 = 'J';
				}
			};
			

		}
		
	</script>



	<h2>First CSV test</h2>

	<script>
		function Table_To_CSV() {
			document.getElementById("fat");

			// csv <- table. ToDo: Make function with callbacks

			var out_0 = "";
			var inp_t = document.getElementById('append_here');
			var inp_0 = inp_t.getElementsByTagName('TBODY')[0];

			// body

			//var inp_lines=inp_0.split('\n');
			inp_1 = inp_0.childNodes;
			for ( var i0 = 0; i0 < inp_1.length; i0++) {
				var line = inp_1[i0];

				if (line.nodeType != 1) {
					continue;
				}

				var out_1 = "";

				var fields = line.childNodes;
				for ( var i1 = 0; i1 < fields.length; i1++) {
					var field = fields[i1];

					if (field.nodeType != 1) {
						continue;
					}

					out_1 += "," + field.innerHTML;
				}

				out_0 += '\n' + out_1.substring(1); //not system.newline, but to my spec. Heinricht wants \r \n
			}

			//old uri = "Arne ,Heinrich \nIlse ,Gesa ";

			res = encodeURI(out_0.substring(1));
			document.getElementById("csv").innerHTML = 'data:text/csv;charset=utf-8,'
					+ res;
			// proven, but two click
			//var a = document.getElementById("csv_a");
			//a.href =
				window.open(  // should be one click, but: Test 
				'data:text/csv;charset=utf-8,' + res);
			
		}
	</script>

	<button onclick="Table_To_CSV()">TableToCSV</button>

	<p id="csv"></p>
	<!--  a id="csv_a" download="somedata_dynamic.csv" href="placeholer" >
		click me to save last generated csv</a -->



</body>
</html>